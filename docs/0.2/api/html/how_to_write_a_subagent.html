<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>AgentXcpp: How to write a Subagent</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">AgentXcpp
   &#160;<span id="projectnumber">Revision:0.2</span>
   </div>
   <div id="projectbrief">API Documentation</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.1.2 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('how_to_write_a_subagent.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">How to write a Subagent </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><dl class="section note"><dt>Note</dt><dd>It is assumed that agentXcpp is installed properly; see <a class="el" href="installation.html">Building and Installing AgentXcpp</a> for how to do that.</dd></dl>
<p>This HOWTO explains how to implement, compile and run a trivial subagent. Our trivial subagent has only one variable called 'simpleCounter' which is described within the following MIB:</p>
<pre class="fragment">SIMPLE-MIB DEFINITIONS ::= BEGIN

IMPORTS
    OBJECT-TYPE FROM SNMPv2-SMI
    enterprises FROM SNMPv2-SMI;

simpleCounter OBJECT-TYPE
    SYNTAX INTEGER
    ACCESS read-only
    STATUS current
    DESCRIPTION "A simple counter which is incremented each time
                 it is queried. Starts with 0."
    ::={ enterprises 42 1 }

END
</pre><p>Now let's see how easy this can be implemented with agentXcpp. We implement the simpleCounter variable within the file <code>SimpleCounter.hpp</code> (header-only) and the main() function within <code>simpleagent.cpp</code>.</p>
<h1><a class="anchor" id="implement_class"></a>
Implementing the simpleCounter variable</h1>
<p>The simpleCounter thing described above is an OBJECT-TYPE. OBJECT-TYPE is a description of the object, not the object itself. The OID of simpleCounter is "enterprises.42.1", while the real object will be accessible with OID "enterprises.42.1.0".</p>
<p>In C++, objects are described by their classes (note the difference between classes and objects). The class-object-relation in C++ is similar to the "OBJECT-TYPE"-"object"-relation in SNMP. Therefore, OBJECT-TYPEs are represented by classes in agentXcpp, while SNMP objects are represented by C++ objects.</p>
<p>Our simpleCounter variable will be an object of the class SimpleCounter, which we implement in <code>SimpleCounter.hpp</code>. First of all, we need to include some header files for our SimpleCounter class (and we add a header guard for completeness):</p>
<div class="fragment"><div class="line"><span class="preprocessor">#ifndef _SIMPLECOUNTER_H_</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define _SIMPLECOUNTER_H_</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">// Make the class agentxcpp::Variable available:</span></div>
<div class="line"><span class="preprocessor">#include &lt;agentxcpp/Variable.hpp&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="comment">// Make the class agentxcpp::IntegerValue available:</span></div>
<div class="line"><span class="preprocessor">#include &lt;agentxcpp/IntegerValue.hpp&gt;</span></div>
</div><!-- fragment --><p>All agentXcpp classes are in the namespace 'agentxcpp'. To make the code more readable, we make the namespace globally available:</p>
<div class="fragment"><div class="line"><span class="keyword">using namespace </span>agentxcpp;</div>
</div><!-- fragment --><p>Next, we start our SimpleCounter class:</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>SimpleCounter : <span class="keyword">public</span> Variable&lt;IntegerValue&gt;</div>
<div class="line">{</div>
</div><!-- fragment --><p>The simpleCounter has a value type which is given in the SYNTAX clause in the MIB. AgentXcpp provides various classes to match standard SYNTAX types, all of which inherit from the <a class="el" href="classagentxcpp_1_1_abstract_value.html">AbstractValue</a> class. Our SimpleCounter class uses <a class="el" href="classagentxcpp_1_1_integer_value.html">IntegerValue</a> as its value type.</p>
<p>Next, the <a class="el" href="classagentxcpp_1_1_variable.html#ae90e61672e5d27ba0f50dfbb2ab6628e">get()</a> method from <a class="el" href="classagentxcpp_1_1_variable.html">Variable</a> must be overridden. This method is invoked on SNMP GET requests and returns the current value of the object. In our case, it increments the member variable "counter" and returns the new value:</p>
<div class="fragment"><div class="line"><span class="keyword">private</span>:</div>
<div class="line">    IntegerValue counter;</div>
<div class="line"></div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <span class="keyword">virtual</span> IntegerValue <span class="keyword">get</span>()</div>
<div class="line">    {</div>
<div class="line">        counter.value++;</div>
<div class="line">        <span class="keywordflow">return</span> counter;</div>
<div class="line">    }</div>
</div><!-- fragment --><p>We also add a <code>value()</code> method to obtain the current value without incrementing it. This might become useful in future:</p>
<div class="fragment"><div class="line">        IntegerValue value()</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">return</span> counter;</div>
<div class="line">        }</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#endif  // _SIMPLECOUNTER_H_</span></div>
</div><!-- fragment --><p>And that's it. Next, let's implement the <code>main()</code> function.</p>
<h1><a class="anchor" id="main_function"></a>
Implementing the main() function</h1>
<p>The main() function is implemented in <code>simpleagent.cpp</code>. First the headers:</p>
<div class="fragment"><div class="line"><span class="comment">// Make the class agentxcpp::MasterProxy available:</span></div>
<div class="line"><span class="preprocessor">#include &lt;agentxcpp/MasterProxy.hpp&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="comment">// We need the QCoreApplication class:</span></div>
<div class="line"><span class="preprocessor">#include &lt;QCoreApplication&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="comment">// Our simple counter is implemented here:</span></div>
<div class="line"><span class="preprocessor">#include &quot;SimpleCounter.hpp&quot;</span></div>
</div><!-- fragment --><p>Again, we employ the using directive to ease typing:</p>
<div class="fragment"><div class="line"><span class="keyword">using namespace </span>agentxcpp;</div>
</div><!-- fragment --><p>The first thing to do in <code>main()</code> is to create a QCoreApplication object: </p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>** argv)</div>
<div class="line">{</div>
<div class="line">    QCoreApplication app(argc, argv);</div>
</div><!-- fragment --><p>The agentXcpp library is a QT library, and SNMP request handling is done within the main event loop. Therefore, a QCoreApplication object is needed to provide the event loop. For more information about QCoreApplication refer to the QT documentation.</p>
<p>Next, we create a MasterProxy object:</p>
<div class="fragment"><div class="line">MasterProxy master;</div>
</div><!-- fragment --><p>The class <a class="el" href="classagentxcpp_1_1_master_proxy.html">MasterProxy</a> is used to communicate with the master agent. A MasterProxy can be thought of as a local C++ object representing the remote master agent. The MasterProxy can be in disconnected state at any time, or become disconnected, which means that most operations could possibly fail with an <a class="el" href="classagentxcpp_1_1disconnected.html">disconnected</a> exception.</p>
<p>The default constructor of <a class="el" href="classagentxcpp_1_1_master_proxy.html">MasterProxy</a> tries to connect to the master agent via the unix domain socket <code>/var/agentx/master</code>. Of course, another unix domain socket may be chosen, but it cannot be changed once the <a class="el" href="classagentxcpp_1_1_master_proxy.html">MasterProxy</a> object is created.</p>
<p>Now, as we have the <a class="el" href="classagentxcpp_1_1_master_proxy.html">MasterProxy</a> object, we register a subtree. This means that we provide an OID to the master to indicate that our subagent wishes to serve all requests to OIDs starting with that OID. For our subagent we use "enterprises.42.1", where 'enterprises' is the standard OID "1.3.6.1.4.1". The master will then send all SNMP requests within that subtree to our subagent (e.g. "enterprises.42.1.0" or "enterprises.42.1.1.2.0"), regardless of whether the subagent actually can serve them. If a request cannot be served, the <a class="el" href="classagentxcpp_1_1_master_proxy.html">MasterProxy</a> will take care of it and sends an appropriate error message to the master agent. Thus, our SimpleCounter implementation does not have to deal with that.</p>
<p>And here is the code for subtree registration:</p>
<div class="fragment"><div class="line">OidValue simpleagent_oid = OidValue(<a class="code" href="classagentxcpp_1_1_oid_value.html#a98a55070f77ad6d2531eec22e5a06c00" title="The &#39;iso.org.dod.internet.private.enterprises&#39; OID according to RFC 1155.">enterprises_oid</a>, <span class="stringliteral">&quot;42.1&quot;</span>);</div>
<div class="line">master.register_subtree(simpleagent_oid);</div>
</div><!-- fragment --><p>As you can see, an <a class="el" href="classagentxcpp_1_1_oid_value.html">OidValue</a> object can be created by giving it the "enterprises_oid" object (which is provided by agentXcpp for convenience) and an additional string with further subids.</p>
<p>Next, we create a SimpleCounter variable and register it with agentXcpp:</p>
<div class="fragment"><div class="line">boost::shared_ptr&lt;SimpleCounter&gt; counter(<span class="keyword">new</span> SimpleCounter);</div>
<div class="line"></div>
<div class="line">OidValue simpleCounter_oid(simpleagent_oid, <span class="stringliteral">&quot;0&quot;</span>);</div>
<div class="line"></div>
<div class="line">master.add_variable(simpleCounter_oid, counter);</div>
</div><!-- fragment --><p>This is the place where we create the real SNMP variable 'counter'. This variable is then registered with the master agent by providing its OID (the one with .0) and the object itself. Note that the object is given in form of a shared pointer, which means that is must be created using the 'new' operator.</p>
<p>Finally we start the main event loop in order to receive requests from the master agent:</p>
<div class="fragment"><div class="line">    app.exec();</div>
<div class="line">}</div>
</div><!-- fragment --><p>This function blocks forever.</p>
<h1><a class="anchor" id="compiling"></a>
Compiling the Subagent</h1>
<p>When compiling the subagent, we need to link against the boost libraries 'system_error' and 'pthread', the needed Qt libraries and, of course, against the agentXcpp library. On a GNU/Linux system, you can type the following command:</p>
<div class="fragment"><div class="line">g++ simpleagent.cpp -o simpleagent -lagentxcpp \</div>
<div class="line">    `pkg-config --cflags --libs QtNetwork QtCore`</div>
</div><!-- fragment --><p>This assumes that the agentxcpp library is installed properly, so that the compiler can find the headers and the shared object file. The pkg-config tool is used here to add the compiler flags for QT. Note that we do not compile the SimpleCounter class separately, because it is implemented completely within its header file.</p>
<h1><a class="anchor" id="running"></a>
Running the Subagent</h1>
<p>This step is difficult to describe, because it depends on your system how to get the subagent running. This howto describes the procedure using the NET-SNMP package on linux. That package contains a daemon which can be used as master agent, and some command line tools, which can be used to query the SNMP agent.</p>
<p>We will configure the NET-SNMP agent to act as AgentX master agent. To keep this guide simple, we will use the SNMPv2c protocol using "rw" as read-write community name, but our subagent can of course be queried using SNMPv1 or SNMPv3, as long as the master is configured properly. The subagent implementation is independent of the used SNMP version.</p>
<h2><a class="anchor" id="starting_master"></a>
Starting the Net-SNMP master agent</h2>
<p>First, we add the following lines to its config file <code>/etc/snmp/snmpd.conf</code>:</p>
<pre class="fragment">rwcommunity rw        # use "rw" as read-write-community name
master      agentx    # snmpd shall act as agentX master agent
agentXPerms 0666 777  # make socket world-readable
</pre><p>The community name is needed later, when issuing a SNMP GET request. We set it to "rw" in the example, but you can use anything you wish.</p>
<p>The agentXPerms are not strictly required, but making the socket world-readable saves us some trouble regarding access restrictions. Next, we (re)start the master agent using its init scripts:</p>
<pre class="fragment">/etc/init.d/snmpd stop
/etc/init.d/snmpd start
</pre><p>Note that the path depends on your system. For example in ArchLinux, it is /etc/rc.d/snmpd.</p>
<h2><a class="anchor" id="starting_subagent"></a>
Starting the Subagent</h2>
<p>Now the subagent can be started:</p>
<pre class="fragment">./simpleagent
</pre><p>The subagent should keep sitting in the console, and now we can try if it works.</p>
<h2><a class="anchor" id="querying"></a>
Querying the Subagent</h2>
<p>Our little subagent exposes an INTEGER object with the OID "1.3.6.1.4.1.42.1.0". We can query this object with an SNMP GET request. We use the NET-SNMP utility snmpget (but you can use any tool you wish, of course):</p>
<pre class="fragment">snmpget -v2c -c rw localhost 1.3.6.1.4.1.42.1.0
</pre><p>Or, if the MIB above is put into a file in the right directory, we can also do:</p>
<pre class="fragment">snmpget -v2c -c rw localhost SIMPLE-MIB::simpleCounter.0
</pre><p>Each time the command is executed, the simpleCounter object reports the incremented number. When everything works, your setup has proven to be usable, and you can now go on and <a class="el" href="how_to_add_rw_support.html">add write support</a> to it! </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.1.2 </li>
  </ul>
</div>
</body>
</html>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>AgentXcpp: How to send notifications and traps</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">AgentXcpp
   &#160;<span id="projectnumber">Revision:0.2</span>
   </div>
   <div id="projectbrief">Internals Documentation</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.1.2 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('how_to_send_notifications.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">How to send notifications and traps </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><dl class="section note"><dt>Note</dt><dd>This is a follow-up tutorial to <a class="el" href="how_to_add_rw_support.html">How to implement a writeable variable</a>.</dd></dl>
<p>This HOWTO explains how to send notifications (SNMP v2, v2c and v3) and traps (SNMP v1). Luckily, from a subagent's point of view, there is nearly no difference between traps and notifications. In the following text, the term "notification" is used for notifications <em>and</em> traps.</p>
<p>When a subagent detects some interesting condition, it may send a notification to the master agent. The master agent will then forward it to some SNMP managers, depending on its configuration. The destination of the SNMP notification (or trap) is determined solely by the master agent.</p>
<p>We start with the subagent developed in <a class="el" href="how_to_add_rw_support.html">How to implement a writeable variable</a>, which provides the SNMP variable simpleCounter. This counter is incremented each time it is read. Next we will enhance our implementation so that it sends a notification every second.</p>
<p>First of all, let's augment the SIMPLE-MIB:</p>
<pre class="fragment">SIMPLE-MIB DEFINITIONS ::= BEGIN

IMPORTS
    OBJECT-TYPE FROM SNMPv2-SMI
    enterprises FROM SNMPv2-SMI
    NOTIFICATION-TYPE FROM SNMPv2-SMI;

simpleCounter OBJECT-TYPE
    SYNTAX INTEGER
    ACCESS read-write
    STATUS current
    DESCRIPTION "A simple counter which is incremented each time
                 it is queried. Starts with 0."
    ::={ enterprises 42 1 }

simpleCounterStatus NOTIFICATION-TYPE
    OBJECTS { simpleCounter }
    STATUS current
    DESCRIPTION "A notification sent each 5 seconds."
    ::={ enterprises 42 0 1 }

END
</pre><p>As can be seen, we added the simpleCounterChange notification, which will include the simpleCounter value when sent. Note that the next-to-last subidentifier for notifications must be 0 according to RFC 1902, 8.5. "Mapping 
of the NOTIFICATION-TYPE value".</p>
<h1><a class="anchor" id="implementing_notification"></a>
The Implementation</h1>
<p>So, how do we implement a notification? Normally, a subagent is just sitting there, waiting for SNMP requests and handling them. Notifications typically arise outside of this mechanism. We simulate that by using a timer which fires every second and sends a notification. We will use a QTimer which can use the event loop provided by QT. For this we need a class with a QT slot to which the QTimer can be connected. We name that class <code>NotificationSender</code> and put it into its own file: <code>NotificationSender.hpp</code> (for simplicity we implement the whole class in the header, so we won't need an implementation file). Here ist the <code>NotificationSender.hpp</code> file:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#ifndef _NOTIFICATIONSENDER_H_</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define _NOTIFICATIONSENDER_H_</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;QObject&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;agentxcpp/OidValue.hpp&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;agentxcpp/MasterProxy.hpp&gt;</span></div>
<div class="line"><span class="preprocessor">#include &quot;SimpleCounter.hpp&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">using namespace </span>agentxcpp;</div>
<div class="line"></div>
<div class="line"><span class="keyword">class </span>NotificationSender : <span class="keyword">public</span> QObject</div>
<div class="line">{</div>
<div class="line">    Q_OBJECT</div>
<div class="line"></div>
<div class="line">    <span class="keyword">private</span>:</div>
<div class="line">        <a class="code" href="classagentxcpp_1_1_master_proxy.html" title="This class represents the master agent in a subagent program.">MasterProxy</a>* master;</div>
<div class="line">        <a class="code" href="classagentxcpp_1_1_oid_value.html" title="Represents an SNMP object identifier (OID).">OidValue</a> simpleCounter_oid;</div>
<div class="line">        shared_ptr&lt;SimpleCounter&gt; counter;</div>
<div class="line"></div>
<div class="line">    <span class="keyword">public</span>:</div>
<div class="line">        NotificationSender(<a class="code" href="classagentxcpp_1_1_master_proxy.html" title="This class represents the master agent in a subagent program.">MasterProxy</a>* _master,</div>
<div class="line">                           <a class="code" href="classagentxcpp_1_1_oid_value.html" title="Represents an SNMP object identifier (OID).">OidValue</a> _oid,</div>
<div class="line">                           shared_ptr&lt;SimpleCounter&gt; _counter)</div>
<div class="line">        : master(_master), simpleCounter_oid(_oid), counter(_counter)</div>
<div class="line">        {</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">    <span class="keyword">public</span> slots:</div>
<div class="line">        <span class="keywordtype">void</span> sendNotification()</div>
<div class="line">        {</div>
<div class="line">            std::cout &lt;&lt; <span class="stringliteral">&quot;notification!&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"></div>
<div class="line">            std::vector&lt;varbind&gt; objects;</div>
<div class="line">            shared_ptr&lt;AbstractValue&gt; counter_value(<span class="keyword">new</span> <a class="code" href="classagentxcpp_1_1_integer_value.html" title="Represents an Integer as described in RFC 2741.">IntegerValue</a>(counter-&gt;value()));</div>
<div class="line">            objects.push_back(<a class="code" href="classagentxcpp_1_1varbind.html" title="Represents a VarBind according to RFC 2741, section 5.4.">varbind</a>(simpleCounter_oid, counter_value));</div>
<div class="line"></div>
<div class="line">            QMetaObject::invokeMethod(master, <span class="stringliteral">&quot;send_notification&quot;</span>,</div>
<div class="line">                                      Q_ARG(<span class="keyword">const</span> <a class="code" href="classagentxcpp_1_1_oid_value.html" title="Represents an SNMP object identifier (OID).">OidValue</a>&amp;, simpleCounter_oid),</div>
<div class="line">                                      Q_ARG(<span class="keyword">const</span> std::vector&lt;varbind&gt;&amp;, objects)</div>
<div class="line">                                     );</div>
<div class="line">        }</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#endif // _NOTIFICATIONSENDER_H_</span></div>
</div><!-- fragment --><dl class="todo"><dt><b><a class="el" href="todo.html#_todo000005">Todo:</a></b></dt><dd>Which OID must be given to send_notification()?</dd></dl>
<p>The NotificationSender inherits QObject and uses the Q_OBJECT macro, which is both needed to make the class suitable for QT's signal/slot mechanism. The constructor takes a pointer to the MasterProxy object (needed to send notifications), the simpleCounter's oid (will be included in the notifications) and a pointer to the counter (will be queried to include the value in the notifications). The sendNotification() slot will be connected to the QTimer object and sends a notification each time it is invoked. Also, it performs an output to indicate that a notification is sent, which we will possibly miss as long as the master agent is not yet configured properly.</p>
<p>We use QMetaObject::invokeMethod() here to invoke the MasterProxy::send_notification() slot. This would even work if the NotificationSender were running in a separate thread. In the example, were the NotificationSender and the MasterProxy run in the same thread, a simple call would also work:</p>
<div class="fragment"><div class="line"><span class="comment">// Could be used instead of QMetaObject::invokeMethod(),</span></div>
<div class="line"><span class="comment">// because NotificationSender and MasterProxy run in</span></div>
<div class="line"><span class="comment">// the same thread:</span></div>
<div class="line">master-&gt;send_notification(simpleCounter_oid, objects);</div>
</div><!-- fragment --><p>Next, we augment the code within the <code>main()</code> function. But first, we need additional includes in <code>simpleagent.cpp</code>:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;QTimer&gt;</span></div>
<div class="line"><span class="preprocessor">#include &quot;NotificationSender.hpp&quot;</span></div>
</div><!-- fragment --><p>And this is the complete <code>main()</code> function:</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>** argv)</div>
<div class="line">{</div>
<div class="line">    QCoreApplication app(argc, argv);</div>
<div class="line">    MasterProxy master;</div>
<div class="line"></div>
<div class="line">    OidValue simpleagent_oid = OidValue(<a class="code" href="classagentxcpp_1_1_oid_value.html#a98a55070f77ad6d2531eec22e5a06c00" title="The &#39;iso.org.dod.internet.private.enterprises&#39; OID according to RFC 1155.">enterprises_oid</a>, <span class="stringliteral">&quot;42.1&quot;</span>);</div>
<div class="line">    master.register_subtree(simpleagent_oid);</div>
<div class="line"></div>
<div class="line">    boost::shared_ptr&lt;SimpleCounter&gt; counter(<span class="keyword">new</span> SimpleCounter);</div>
<div class="line">    OidValue simpleCounter_oid(simpleagent_oid, <span class="stringliteral">&quot;0&quot;</span>);</div>
<div class="line">    master.add_variable(simpleCounter_oid, counter);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// New code: ----------------------------------------</span></div>
<div class="line">    NotificationSender sender(&amp;master, simpleCounter_oid, counter);</div>
<div class="line"></div>
<div class="line">    QTimer timer;</div>
<div class="line">    QObject::connect(&amp;timer, SIGNAL(timeout()),</div>
<div class="line">                     &amp;sender, SLOT(sendNotification()));</div>
<div class="line">    timer.setInterval(1000); <span class="comment">// 1000 milliseconds</span></div>
<div class="line">    timer.start();</div>
<div class="line">    <span class="comment">// --------------------------------------------------</span></div>
<div class="line"></div>
<div class="line">    app.exec();</div>
<div class="line">}</div>
</div><!-- fragment --><p>First, we create a NotificationSender object. Then, we create a QTimer object, connect its <code>timeout()</code> signal to the NotificationSender's <code>sendNotification()</code> slot, configure its interval to 1 second (the timer is repetitive by default), and start it.</p>
<h1><a class="anchor" id="compiling_notification"></a>
Compiling the Subagent</h1>
<p>Compiling the subagent becomes a bit more complicated, because we need to invoke QT's meta-object compiler (moc) for the NotificationSender class, which we do first:</p>
<div class="fragment"><div class="line">moc-qt4 `pkg-config --cflags QtCore QtNetwork` \</div>
<div class="line">        -o moc_NotificationSender.cc \
        NotificationSender.hpp</div>
</div><!-- fragment --><p>This compiles the header <code>NotificationSender.hpp</code> into the file <code>moc_NotificationSender.cc</code>. Next, we compile this file into an object file:</p>
<div class="fragment"><div class="line">g++ -c moc_NotificationSender.cc `pkg-config --cflags QtCore QtNetwork`</div>
</div><!-- fragment --><p>Finally we compile the <code>simpleagent.cpp</code> and link it against the generated object file:</p>
<div class="fragment"><div class="line">g++ simpleagent.cpp -o simpleagent moc_NotificationSender.o \</div>
<div class="line">        `pkg-config --cflags --libs QtNetwork QtCore` \</div>
<div class="line">        -lagentxcpp</div>
</div><!-- fragment --><p>Now, the executable is ready to run.</p>
<h1><a class="anchor" id="running_notification"></a>
Running the Subagent</h1>
<h2><a class="anchor" id="master_agent"></a>
The master agent</h2>
<p>The subagent is run as described in <a class="el" href="how_to_write_a_subagent.html">How to write a Subagent</a>, but to make notifications work, we need additional configuration for the master agent. For the NET-SNMP master agent, add the following line to its configuration file <code>/etc/snmp/snmpd.conf</code>:</p>
<pre class="fragment">informsink udp:127.0.0.1 rw
</pre><p>This line means that notifications are sent to the address 127.0.0.1, using the default port (which is 162) and the community string "rw" (which we also used in <a class="el" href="how_to_write_a_subagent.html">How to write a Subagent</a>). Next, we (re)start the master agent using its init scripts:</p>
<pre class="fragment">/etc/init.d/snmpd stop
/etc/init.d/snmpd start
</pre><p>Note that the path depends on your system. For example in ArchLinux, it is /etc/rc.d/snmpd.</p>
<h2><a class="anchor" id="snmptrapd"></a>
The snmptrapd program</h2>
<p>To receive notifications, we use the snmptrapd program from the NET-SNMP package. First, we have to configure it. Make sure that the following line is contained in <code>/etc/snmp/snmptrapd.conf</code>:</p>
<pre class="fragment">authCommunity log rw
</pre><p>That line enables logging for notifications with the community string "rw". Now start the program <b>as root</b>. The program must be run as root, because it needs to listen on the privileged port 162.</p>
<pre class="fragment"># As root:
snmptrapd -f -Le
</pre><p>The <code>-f</code> parameter forces the program to stay in the foreground, so we can see its output. The <code>-Le</code> parameter redirects the logging messages to stderr (i.e. to the console window).</p>
<h2><a class="anchor" id="starting_subagent"></a>
Starting the Subagent</h2>
<p>The subagent is started as last times:</p>
<pre class="fragment">./simpleagent
</pre><p>If all went right, we can see notifications arriving in the snmptrapd console, with each notification reporting the current counter value. Try some SNMP get and get requests:</p>
<pre class="fragment">snmpget -v1 -c rw localhost SIMPLE-MIB::simpleCounter.0
</pre><pre class="fragment">snmpset -v1 -c rw localhost SIMPLE-MIB::simpleCounter.0 i 42
</pre><p>This increases or sets the counter value, and the new values are reported within the notifications. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.1.2 </li>
  </ul>
</div>
</body>
</html>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>AgentXcpp: Parsing incoming PDUs</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">AgentXcpp
   &#160;<span id="projectnumber">Revision:0.2</span>
   </div>
   <div id="projectbrief">Internals Documentation</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.1.2 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('parsing.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Parsing incoming PDUs </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This section explains how PDU parsing is done in agentXcpp.</p>
<p>AgentX PDUs are read from a stream, constructing C++ objects which represent the PDUs and all their parts (such as varbinds, for example). In general, the C++ objects, such as OpenPDU, varbind, OidValue or IntegerValue, are created by providing an iterator (pointing into a buffer) to their constructors. The constructor uses the iterator to read the serialized form of the object and construct the C++ object accordingly. Along the way, the iterator is modified to point behind the object which was just deserialized.</p>
<p>An example of such a constructor is <a class="el" href="classagentxcpp_1_1varbind.html#afc4150568c206d79391495d184143197" title="Create a VarBind with an oid and a var.">agentxcpp::varbind::varbind</a>(binary::const_iterator&amp; pos, binary::const_iterator&amp; end, bool big_endian). It takes an iterator ('pos') and begins parsing at where 'pos' points to. While reading, the varbind object is constructed. A varbind always contains (at least) an OidValue. The varbind constructor therefore creates an OidValue object by passing the 'pos' iterator to the constructor of the OidValue class, which reads the serialized OidValue and constructs the OidValue object. If needed, another variable is created the same way (e.g. an IntegerValue or an OctetStringValue). When the varbind object is fully constructed, the 'pos' iterator points to the position behind the varbind and the constructor returns. Note that the iterator is modified by the constructor. The caller may then use 'pos' to create the next object, until the buffer is completely parsed.</p>
<p>The 'end' iterator seen in the above constructor prototype is needed to know the end of the buffer. Parse constructors use it to detect missing data at the end of the buffer. For example, the serialized form of an Integer is 4 bytes in size; if pos points to the last byte in the buffer, the integer is corrupted. This can be detected using the 'end' iterator.</p>
<p>Reading a PDU is initiated by calling the static class function agentxcpp::PDU::get_pdu(boost::asio::local::stream_protocol::socket&amp; in, unsigned timeout=1000). The function first reads the PDU from the socket into a buffer. It then interprets the PDU header and creates a concrete PDU object (e.g. OpenPDU) corresponding to the type field found in the header. The PDU and its subobjects are created as described above. Finally, a pointer to the created object is returned, and the caller is responsible for deleting it when it is not longer needed.</p>
<p>The <a class="el" href="classagentxcpp_1_1_p_d_u.html" title="The base class of all PDU&#39;s.">agentxcpp::PDU</a> class cannot be instantiated itself, as it does not represent a PDU type defined in RFC 2741. It serves as base class for the concrete PDU types. Each concrete PDU type (for example the OpenPDU class) inherits from PDU. The constructor of such a concrete class must call the constructor of the PDU class, which parses the header. Example:</p>
<div class="fragment"><div class="line">OpenPDU::OpenPDU(binary::const_iterator&amp; pos, <span class="keywordtype">bool</span> big_endian)</div>
<div class="line">    : PDU(pos, big_endian) <span class="comment">// parse header</span></div>
<div class="line">{</div>
<div class="line">    timeout = *pos++;                          <span class="comment">// parse timeout field</span></div>
<div class="line">    pos += 3;                                  <span class="comment">// skip reserved fields</span></div>
<div class="line">    <span class="keywordtype">id</span> = OidValue(pos, big_endian);            <span class="comment">// parse OidValue</span></div>
<div class="line">    descr = OctetStringValue(pos, big_endian); <span class="comment">// parse desciption</span></div>
<div class="line">}</div>
</div><!-- fragment --><p>Note that the header is parsed two times. The first time is in the agentxcpp::PDU::get_pdu() function (described above), where the header is inspected to determine the payload length, the PDU type and the endianess of the PDU. The protocol version is also checked in PDU::get_pdu(). The second time is in the <a class="el" href="classagentxcpp_1_1_p_d_u.html#a8d96b5507dd2551eeb26114d0bd46119" title="Default constructor.">agentxcpp::PDU::PDU()</a> constructor, where the sessionID, transactionID, packetID and some flags are picked up. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.1.2 </li>
  </ul>
</div>
</body>
</html>
